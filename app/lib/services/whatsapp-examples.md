# Ejemplos de Uso - Servicio de WhatsApp

Este documento contiene ejemplos pr√°cticos de c√≥mo usar el servicio de WhatsApp en Agrobeat.

## üì± Tabla de Contenidos

1. [Mensajes de Texto Simple](#mensajes-de-texto-simple)
2. [Plantillas de WhatsApp](#plantillas-de-whatsapp)
3. [Casos de Uso Comunes](#casos-de-uso-comunes)
4. [Crear Plantillas en Meta](#crear-plantillas-en-meta)

---

## Mensajes de Texto Simple

### Enviar un mensaje b√°sico

```typescript
import { sendTextMessage } from '@/app/lib/services/whatsapp';

const result = await sendTextMessage({
  to: '+595981123456',
  message: 'Hola, tu inversi√≥n fue confirmada exitosamente.',
  previewUrl: true // Opcional, muestra preview de URLs
});

if (result.success) {
  console.log('‚úÖ Mensaje enviado:', result.messageId);
} else {
  console.error('‚ùå Error:', result.error);
}
```

### Enviar a m√∫ltiples usuarios

```typescript
import { sendBulkTextMessage } from '@/app/lib/services/whatsapp';

const phones = ['+595981123456', '+595982234567', '+595983345678'];
const message = 'Nueva campa√±a disponible. ¬°Visita tu dashboard!';

const result = await sendBulkTextMessage(phones, message);

console.log(`üìä Enviados: ${result.successful}/${result.total}`);
console.log(`‚ùå Fallidos: ${result.failed}`);
```

---

## Plantillas de WhatsApp

Las plantillas son mensajes pre-aprobados por Meta que pueden incluir variables din√°micas.

### Plantilla Simple (Solo Body)

**Plantilla en WhatsApp Manager:**
```
Hola {{1}}, tu inversi√≥n de {{2}} plantas en la campa√±a {{3}} fue confirmada exitosamente.
```

**C√≥digo:**
```typescript
import { sendTemplateMessage, createBodyComponent } from '@/app/lib/services/whatsapp';

const result = await sendTemplateMessage({
  to: '+595981123456',
  templateName: 'inversion_confirmada',
  languageCode: 'es',
  components: [
    createBodyComponent(['Juan P√©rez', '100', 'Tomate Org√°nico'])
  ]
});
```

### Plantilla con Header de Imagen

**Plantilla en WhatsApp Manager:**
- Header: Imagen
- Body: `Nueva campa√±a disponible: {{1}} en {{2}}. ¬°Invierte desde {{3}}!`
- Button: `Ver Campa√±a` ‚Üí `https://agrobeat.com/campaign/{{1}}`

**C√≥digo:**
```typescript
import { sendTemplateMessage } from '@/app/lib/services/whatsapp';
import { 
  createImageHeaderComponent,
  createBodyComponent,
  createUrlButtonComponent 
} from '@/app/lib/services/whatsapp-helpers';
import { formatCurrency } from '@/lib/utils';

const campaignId = 123;
const campaign = {
  title: 'Tomate Org√°nico',
  location: 'Caazap√°',
  minInvestment: 500000,
  imageUrl: 'https://agrobeat.com/images/tomate.jpg'
};

const result = await sendTemplateMessage({
  to: '+595981123456',
  templateName: 'nueva_campana',
  languageCode: 'es',
  components: [
    createImageHeaderComponent(campaign.imageUrl),
    createBodyComponent([
      campaign.title,
      campaign.location,
      formatCurrency(campaign.minInvestment)
    ]),
    createUrlButtonComponent(campaignId.toString())
  ]
});
```

### Plantilla con Header de Texto

**Plantilla en WhatsApp Manager:**
- Header: `{{1}}`
- Body: `Hola {{1}}, tu pago de {{2}} fue confirmado. ¬°Gracias por invertir!`

**C√≥digo:**
```typescript
import { 
  sendTemplateMessage,
  createTextHeaderComponent,
  createBodyComponent
} from '@/app/lib/services/whatsapp';
import { formatCurrency } from '@/lib/utils';

const result = await sendTemplateMessage({
  to: '+595981123456',
  templateName: 'pago_confirmado',
  languageCode: 'es',
  components: [
    createTextHeaderComponent('‚úÖ Pago Confirmado'),
    createBodyComponent([
      'Juan P√©rez',
      formatCurrency(5000000)
    ])
  ]
});
```

### Plantilla Compleja (Todo incluido)

**Plantilla en WhatsApp Manager:**
- Header: Imagen
- Body: `Hola {{1}}, tu inversi√≥n en {{2}} est√° en producci√≥n. üìä Plantas: {{3}} üí∞ Inversi√≥n: {{4}} üìÖ Retorno estimado: {{5}}`
- Button 1: `Ver Mi Inversi√≥n` ‚Üí `https://agrobeat.com/tracking/{{1}}`
- Button 2: `Contactar Soporte`

**C√≥digo:**
```typescript
import { 
  sendTemplateMessage,
  createImageHeaderComponent,
  createBodyComponent,
  createUrlButtonComponent
} from '@/app/lib/services/whatsapp';
import { formatCurrency } from '@/lib/utils';

const investmentId = 'INV-123';
const investment = {
  userName: 'Juan P√©rez',
  campaignTitle: 'Tomate Org√°nico',
  plantCount: 100,
  amount: 5000000,
  estimatedReturn: '3 meses',
  imageUrl: 'https://agrobeat.com/images/produccion.jpg'
};

const result = await sendTemplateMessage({
  to: '+595981123456',
  templateName: 'inversion_en_produccion',
  languageCode: 'es',
  components: [
    createImageHeaderComponent(investment.imageUrl),
    createBodyComponent([
      investment.userName,
      investment.campaignTitle,
      investment.plantCount.toString(),
      formatCurrency(investment.amount),
      investment.estimatedReturn
    ]),
    createUrlButtonComponent(investmentId, 0) // Primer bot√≥n
  ]
});
```

---

## Casos de Uso Comunes

### 1. Notificar Inversi√≥n Confirmada

```typescript
import { sendTemplateMessage, createBodyComponent } from '@/app/lib/services/whatsapp';
import { formatCurrency } from '@/lib/utils';

export async function notifyInvestmentConfirmed(
  phoneNumber: string,
  userName: string,
  campaignTitle: string,
  plantCount: number,
  amount: number
) {
  return await sendTemplateMessage({
    to: phoneNumber,
    templateName: 'inversion_confirmada',
    languageCode: 'es',
    components: [
      createBodyComponent([
        userName,
        plantCount.toString(),
        campaignTitle,
        formatCurrency(amount)
      ])
    ]
  });
}

// Uso
await notifyInvestmentConfirmed(
  '+595981123456',
  'Juan P√©rez',
  'Tomate Org√°nico',
  100,
  5000000
);
```

### 2. Notificar Pago Pendiente

```typescript
import { sendTextMessage } from '@/app/lib/services/whatsapp';
import { formatCurrency } from '@/lib/utils';

export async function notifyPendingPayment(
  phoneNumber: string,
  userName: string,
  amount: number,
  daysLeft: number
) {
  const message = `Hola ${userName}, recordatorio: tienes un pago pendiente de ${formatCurrency(amount)}. 
  
‚è∞ Tiempo restante: ${daysLeft} d√≠as

Para confirmar tu pago, contacta con nosotros al 0971-781947.

¬°Gracias por confiar en Agrobeat! üå±`;

  return await sendTextMessage({
    to: phoneNumber,
    message,
    previewUrl: false
  });
}
```

### 3. Notificar Nueva Campa√±a a Todos los Usuarios

```typescript
import { sendTemplateMessage, createBodyComponent } from '@/app/lib/services/whatsapp';
import { formatCurrency } from '@/lib/utils';
import { db } from '@/app/db';

export async function notifyNewCampaignToAll(campaign: {
  title: string;
  location: string;
  minInvestment: number;
  expectedReturn: string;
  closingDays: number;
}) {
  // Obtener usuarios con n√∫mero de tel√©fono
  const users = await db.query.users.findMany({
    where: (users, { isNotNull }) => isNotNull(users.phone),
    columns: {
      phone: true,
      name: true,
    }
  });

  const results = await Promise.allSettled(
    users.map(user =>
      sendTemplateMessage({
        to: user.phone!,
        templateName: 'nueva_campana_disponible',
        languageCode: 'es',
        components: [
          createBodyComponent([
            user.name || 'Inversor',
            campaign.title,
            campaign.location,
            formatCurrency(campaign.minInvestment),
            campaign.expectedReturn,
            campaign.closingDays.toString()
          ])
        ]
      })
    )
  );

  const successful = results.filter(r => r.status === 'fulfilled').length;
  
  return {
    total: users.length,
    successful,
    failed: users.length - successful
  };
}
```

### 4. Recordatorio de Cierre de Campa√±a

```typescript
import { sendTextMessage } from '@/app/lib/services/whatsapp';

export async function sendCampaignClosingReminder(
  phoneNumber: string,
  userName: string,
  campaignTitle: string,
  hoursLeft: number
) {
  const message = `‚è∞ ¬°√öLTIMA OPORTUNIDAD!

Hola ${userName}, la campa√±a "${campaignTitle}" cierra en ${hoursLeft} horas.

üå± A√∫n est√°s a tiempo de invertir
üí∞ Asegura tu retorno
üìä Plantas disponibles limitadas

¬°No te quedes fuera! Reserva ahora: https://agrobeat.com/dashboard`;

  return await sendTextMessage({
    to: phoneNumber,
    message,
    previewUrl: true
  });
}
```

---

## Crear Plantillas en Meta

### Paso a Paso

1. **Accede a Meta Business Manager**
   - Ve a https://business.facebook.com/
   - Selecciona tu cuenta de negocio

2. **Navega a WhatsApp Manager**
   - Men√∫ lateral ‚Üí WhatsApp
   - Selecciona "Message Templates"

3. **Crea una Nueva Plantilla**
   - Click en "Create Template"
   - Nombre: Usa solo min√∫sculas y guiones bajos (ej: `inversion_confirmada`)
   - Categor√≠a: Selecciona apropiadamente (Marketing, Utility, Authentication)
   - Idioma: Espa√±ol

4. **Dise√±a tu Plantilla**

   **Header (Opcional):**
   - Texto: `Inversi√≥n Confirmada` o `{{1}}` para texto din√°mico
   - Imagen: Selecciona "Image" y carga un ejemplo
   - Video: Selecciona "Video" para plantillas con video

   **Body (Obligatorio):**
   ```
   Hola {{1}}, tu inversi√≥n de {{2}} plantas en la campa√±a {{3}} fue confirmada exitosamente por un monto de {{4}}.
   ```
   - Usa `{{1}}`, `{{2}}`, etc. para variables
   - M√°ximo: 1024 caracteres

   **Footer (Opcional):**
   ```
   Agrobeat - Inversiones Agr√≠colas
   ```

   **Buttons (Opcional):**
   - Quick Reply: Botones de respuesta r√°pida
   - Call to Action: Botones con URL o tel√©fono
   - URL Din√°mica: `https://agrobeat.com/tracking/{{1}}`

5. **Env√≠a para Aprobaci√≥n**
   - Revisa que todo est√© correcto
   - Click en "Submit"
   - La aprobaci√≥n puede tomar 24-48 horas

### Ejemplo de Plantilla Completa

**Nombre:** `inversion_confirmada`
**Categor√≠a:** Utility
**Idioma:** Spanish (es)

**Header:**
```
‚úÖ Inversi√≥n Confirmada
```

**Body:**
```
Hola {{1}}, 

Tu inversi√≥n fue confirmada exitosamente:

üå± Campa√±a: {{2}}
üìä Plantas: {{3}}
üí∞ Monto: {{4}}
üìÖ Fecha: {{5}}

Puedes seguir el progreso de tu inversi√≥n desde tu dashboard.

¬°Gracias por confiar en Agrobeat!
```

**Footer:**
```
Agrobeat - Inversiones Agr√≠colas Inteligentes
```

**Buttons:**
- Button 1: [URL] "Ver Mi Inversi√≥n" ‚Üí `https://agrobeat.com/tracking/{{1}}`
- Button 2: [Quick Reply] "Contactar Soporte"

---

## Tips y Mejores Pr√°cticas

### ‚úÖ Hacer

- Crear plantillas con mensajes claros y concisos
- Usar variables para personalizar los mensajes
- Probar las plantillas antes de enviarlas masivamente
- Mantener un tono profesional y amigable
- Incluir siempre informaci√≥n relevante

### ‚ùå Evitar

- Enviar spam o mensajes no solicitados
- Usar plantillas para contenido promocional excesivo
- Abusar de emojis o caracteres especiales
- Enviar mensajes muy largos
- Usar informaci√≥n sensible sin encriptar

### üìä L√≠mites de WhatsApp Business API

- **Mensajes de plantilla:** 1000 destinatarios √∫nicos por d√≠a (tier inicial)
- **Mensajes de sesi√≥n:** Ilimitados (24 horas despu√©s de que el usuario responda)
- **Caracteres:** M√°ximo 1024 en el body
- **Variables:** M√°ximo 4 variables por componente

---

## Recursos Adicionales

- [Documentaci√≥n oficial de WhatsApp Business API](https://developers.facebook.com/docs/whatsapp)
- [Gu√≠a de plantillas de WhatsApp](https://developers.facebook.com/docs/whatsapp/message-templates)
- [Meta Business Manager](https://business.facebook.com/)

